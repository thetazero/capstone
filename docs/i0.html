<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Case I0</title>
  <link rel="stylesheet" href="https://thetazero.github.io/style.css">
  <style>
    .bad {
      color: hsl(0, 100%, 70%);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Case I0</h1>
    <hr>
    <span class="bad" id="loading">loading…</span>
    <p>
      Type in the inputs into the text boxes bellow, for alpha just type in a number. For p and q type in a vector in
      this form [1, 2]. Debth determines the debth to which the continued fraction is approximated.
    </p>
    <p>
      <b>α:</b><input type="text" id="alpha-input" placeholder="alpha" value="1">
      <b>p:</b><input type="text" id="p" placeholder="p vector" value="[3, 1]" onkeyup="setPQ()">
      <b>q:</b><input type="text" id="q" placeholder="q vector" value="[-1, 2]" onkeyup="setPQ()">
      <b>debth:</b><input type="text" id="debth" placeholder="debth" value="10">
      <input type="button" value="solve" onclick="solveBtn()">
    </p>
    <div id="vector-controls">

    </div>
    <div id="calculator" style="width:100%; height:min(50vw, 70vh)"></div>

  </div>
  <script src="https://www.desmos.com/api/v1.5/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
  <script src="wasm_exec.js"></script>
  <script>
    const go = new Go();
    let mod, inst;
    WebAssembly.instantiateStreaming(fetch("i0.wasm"), go.importObject).then(async result => {
      mod = result.module;
      inst = result.instance;
      await go.run(inst);
    });
  </script>
  <script>
    let p = [3, 1];
    let q = [-1, 2];

    function setPQ() {
      p = parseVector(document.querySelector("#p").value)
      q = parseVector(document.querySelector("#q").value)
    }

    function solveBtn() {
      let alpha = parseFloat(document.querySelector("#alpha-input").value)
      p = parseVector(document.querySelector("#p").value)
      q = parseVector(document.querySelector("#q").value)
      let debth = parseInt(document.querySelector("#debth").value)
      let result = solve(alpha, p, q, debth)
      console.log(result)

      let fbot = PolynomialString(result['fbot'])
      let ftop = PolynomialString(result['ftop'])
      let fbotplus1 = PolynomialString(result['fbotplus1'])

      let gbot = PolynomialString(result['gbot'])
      let gtop = PolynomialString(result['gtop'])
      let gbotplus1 = PolynomialString(result['gbotplus1'])

      calculator.setExpression({ id: 'graph1', latex: `f(x)=(${ftop})/(${fbot})`, color: "#2d70b3" })
      calculator.setExpression({ id: 'f_error', latex: `\\left|y-\\frac{${ftop}}{${fbot}}\\right|<\\frac{1}{(${fbot})(${fbotplus1})}`, color: "#3d80c3" })
      calculator.setExpression({ id: 'graph2', latex: `g(x)=(${gtop}) /(${gbot})`, color: "#fa7e19" })
      calculator.setExpression({ id: 'g_error', latex: `\\left|y-\\frac{${gtop}}{${gbot}}\\right|<\\frac{1}{(${gbot})(${gbotplus1})}`, color: "ff8d19" })
      calculator.setExpression({ id: 'graph3', latex: `f(x)+g(x)+x/${result['p0']}`, color: "#000000" })
    }

    function PolynomialString(vector) {
      let poly = ""
      for (let i = 0; i < vector.length; i++) {
        poly += `${vector[i]}x^{${i}}`
        if (i != vector.length - 1) {
          poly += "+"
        }
      }
      return poly
    }

    function parseVector(text) {
      text = text.replace(/</g, "[").replace(/>/, "]").replace(/\(/g, "[").replace(/\)/g, "]")
      return JSON.parse(text)
    }

    const calcElem = document.getElementById('calculator');
    const calculator = Desmos.GraphingCalculator(calcElem);
    calculator.updateSettings({
      projectorMode: true,
      invertedColors: true,
      expressionsCollapsed: true,
    })
    calculator.setMathBounds({
      left: -0.1,
      right: 5,
      bottom: -0.1,
      top: 1.2,
    })
    calculator.setDefaultState(calculator.getState())
  </script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.1.9/lib/p5.js"></script>
  <script src="vectorControls.js"></script>
</body>

</html>